<!DOCTYPE html>
<html lang="ja">

<head>
    <title>アドすたっと</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/chartist.js/latest/chartist.min.css">
    <script src="//cdn.jsdelivr.net/chartist.js/latest/chartist.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src='//cdn.ractivejs.org/latest/ractive.min.js'></script>
    <script src='//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore-min.js'></script>

</head>

<body>
    <h1>Qiita Advent Calendar 2014 はてブ数集計結果</h1>
    <div id='container'></div>
    <h2>各テーマ毎の合計</h2>
    <div class="ct-chart id-all"></div>
    <script id='template' type='text/ractive'>
        {{#themes}}
        <h2>{{title}}</h2>
        <div class="ct-chart id-{{id}}"></div>
        {{/themes}}
    </script>
    <script>
        $(function()
        {
            $.getJSON("results.json", function(json)
            {
                var themes = _.map(json, function(theme, index, list)
                {
                    var hatebuCounts = _.map(theme['entries'],
                        function(entry, index, list)
                        {
                            return entry['count'] + 0;
                        })
                    console.log(hatebuCounts);
                    var hatebuSum = _.reduce(hatebuCounts,
                        function(memo, num)
                        {
                            return 0 + memo + num;
                        }, 0)
                    console.log(hatebuSum);
                    return {
                        id: index,
                        title: theme['themeTitle'],
                        hatebuSum: hatebuSum,
                        chartData:
                        {
                            labels: _.range(1, 26),
                            series: [
                                hatebuCounts
                            ]
                        }
                    };
                });

                console.log(json);
                console.log(themes);

                // レンダリング
                var ractive = new Ractive(
                {
                    el: 'container',
                    template: '#template',
                    data:
                    {
                        themes: themes
                    }
                });

                // グラフの表示
                var option = {
                    low: 0,
                    showArea: true
                };
                var allData = {
                    labels: _.map(themes, function(theme)
                    {
                        return theme['title']
                    }),
                    series: [_.map(themes, function(theme)
                    {
                        return theme['hatebuSum']
                    })]
                }
                console.log(allData);
                new Chartist.Bar('.ct-chart.id-all', allData, option);
                for (var i = 0; i < json.length; i++)
                {
                    new Chartist.Bar('.ct-chart.id-' + themes[i]['id'],
                        themes[i]['chartData'], option);
                }

            });
        });
    </script>
</body>

</html>
